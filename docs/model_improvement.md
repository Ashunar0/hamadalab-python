# Pitch Classification モデル精度改善提案

## 1. データレベルの改善

### 1.1 標本の質
- **課題**: Notebook では 2023/04-10 の全投球を一括取得し、球種に関わらず使用している。捕球失敗やシステム未分類の投球が混ざってモデルがノイズを学習している。
- **理由**: ラベルの品質が悪いと複雑なモデルでも上限性能が低くなる。
- **改善案**: 
  - `pitch_type` が `null` や `UN` の投球、`release_speed`/`spin_axis` 等のコア特徴量に欠損がある投球を取得直後に除外。
  - ボールイベント、投球種別が少なすぎる投手を訓練セットから除外し、検証用に確保。
  - 投手別・期間別の”バランス済み”データセットを作り、モデルごとに固定シードで利用する。

### 1.2 クラス不均衡
- **課題**: メジャーリーグでは FF、SL などの球種が多数派で、マイナー球種の F1 が低くなる。
- **理由**: Stratifed split だけでは多数派優勢が残るため、精度指標が高くても特定球種で失敗する。
- **改善案**:
  - SMOTE、ADASYN でマイナー球種をシンセティックに補完し、`class_weight='balanced'` を維持。
  - 投手単位で球種数が一定以上あるケースのみ学習に使い、小サンプルは別モデルや Others にまとめる。
  - Macro F1 を最適化するハイパーパラメータ探索を採用。

## 2. 特徴量エンジニアリング

### 2.1 力学・生体情報
- **課題**: Notebook では速度・回転・変化量のみ。投手固有のリリース差やボールの軌跡から得られる情報が不足している。
- **改善案**:
  - リリースポイントの変化率（連続投球差分）、リリース拡張（release_extension）、投手左右、打者左右、プレイ状況（balls/strikes、アウトカウント）を特徴に追加。
  - `spin_axis` を sin/cos に変換した上で、`total_break` や `horz_break`, `vert_break` など Statcast 派生量を追加。
  - 投手×球種ごとの平均速度/回転などを `Rolling` で作り、投手固有の球種プロファイルを表現。

### 2.2 特徴量選択と重要度
- **課題**: 現状はすべての特徴量をそのまま使用している。ノイズの多い特徴がモデルの決定境界を歪めている可能性。
- **改善案**:
  - LightGBM/Permutation Importance や SHAP で重要度を評価し、寄与が小さい特徴を削除。
  - PCA や UMAP で低次元表現を追加し、ツリーモデル以外（ロジスティック回帰、SVM）もアンサンブルに組み込む。

## 3. モデル・学習

### 3.1 ハイパーパラメータ探索
- **課題**: Notebook の XGBoost/LGBM は固定パラメータで学習している。
- **改善案**:
  - Optuna + LightGBM/XGBoost を導入し、学習率・木の深さ・min_child_weight・subsample などの検索空間を定義して自動探索。
  - RandomForest も `max_features`, `min_samples_leaf` を探索し、過学習を抑制。

### 3.2 モデルアーキテクチャ
- **課題**: 木系モデルのみで構成されているため、相互作用を別の観点で学習するモデルがない。
- **改善案**:
  - 勾配ブースティング + 線形モデル (glmnet) のスタッキング。後段のメタモデルにはロジスティック回帰を採用。
  - Temporal Convolution や Transformer を使い、同打席内のシーケンスで球種を当てるディープラーニングモデルを追加して比較。
  - CatBoost を導入し、カテゴリ特徴（投手/打者/球場）を直接扱う。

### 3.3 検証手法
- **課題**: 現状は単一の train/valid split。投手単位のリークや期間差による性能崩壊が検知できない。
- **改善案**:
  - `GroupKFold`（投手 ID）、`TimeSeriesSplit`（試合日付）で複数の検証セットを作成。
  - クロスバリデーション結果を平均・分散でレポートし、早期打ち切り基準を設ける。

## 4. トレーニングパイプラインとロギング

- **課題**: Notebook 中で手動操作のため、実験履歴が残らない。再学習時の再現性も不足。
- **改善案**:
  - Hydra/MLflow を導入し、実験条件とメトリクスを記録。学習済みモデルと同じバージョンの特徴量・ラベルエンコーダを保存。
  - 学習スクリプト実行時に WandB 等へリアルタイムでログを送信し、収束挙動を可視化。

## 5. 優先度の目安
1. データ品質とクラスバランスの改善により、ラベルノイズを除去。
2. 特徴量拡張 + Pipeline 化で一貫した前処理を構築。
3. 高度なハイパーパラメータ探索・新規モデルの追加。
4. MLflow 等で実験管理とロギングを整備し、再現性を確保。
