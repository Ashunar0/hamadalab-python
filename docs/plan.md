
# Pitch Classification 改善計画

## 目的
Statcast 投球データを用いた球種分類モデルをより実運用に近づけるため、データ取得から評価・デプロイといった一連の流れを再設計し、再現性・精度・運用性を高める。

## 改善テーマとアクション

### 1. データ取得・管理
- **取得条件の外部化**: シーズン、投手、登板期間などを設定ファイルや CLI 引数で指定できるよう関数化し、Notebook 依存を解消する。
- **キャッシュとバージョニング**: `pybaseball` で取得した生データを Feather/Parquet で保存し、メタデータ（取得日時・クエリ条件・pybaseball バージョン）を付与して再利用可能にする。
- **データ品質チェック**: 特徴量欠損や異常値を検出する検証スクリプトを用意し、実行結果をログに残す。閾値越え時は処理を中断できるようにする。

### 2. 前処理・特徴量エンジニアリング
- **Pipeline 化**: 標準化・欠損補完・ラベルエンコーディングを `sklearn` の `Pipeline` や `ColumnTransformer` で定義し、学習時と推論時の一貫性を担保する。
- **ターゲットバランス対策**: クラス不均衡への対策として SMOTE、クラス重み、あるいは階層化サンプリングを導入し、マイナー球種の性能を改善する。
- **ドメイン特徴量の拡張**: リリースポイントの変化率、同投手の球速帯クラスタ、試合状況（カウント、ランナー）の追加など、野球知識に基づく特徴量を段階的に追加し、重要度を検証する。

### 3. モデル構築・評価
- **検証戦略の強化**: クロスバリデーションや時系列分割を導入し、ハイパーパラメータ探索を Optuna/LightGBM CV で自動化。投手単位でリークが起きないよう GroupKFold を検討する。
- **評価指標の拡充**: マクロ/加重 F1、ログロス、Top-3 精度などを追加し、球種ごとの混同行列ヒートマップを自動生成。結果を HTML/Markdown レポートとして出力する。
- **モデル管理**: モデルアーチファクト（学習済みモデル、エンコーダ、特徴量リスト）を `models/` に保存し、バージョン番号と学習条件を YAML で記録。ベストモデルの自動保存ロジックを追加する。

### 4. 再現性・運用
- **Notebook からスクリプトへ**: Notebook の処理を `src/` 配下に再構成し、`make train` などのエントリーポイントを用意。Notebook は可視化・探索専用にする。
- **環境管理**: `requirements.txt` を `poetry`/`pip-tools` でロックし、`pybaseball` などの依存バージョンを固定。`README` にセットアップ手順と GPU/CPU 要件を明記する。
- **自動テスト**: 主要な前処理関数・特徴量生成の単体テストを `pytest` で整備し、GitHub Actions 等で静的検査（lint）、データ取得のスモークテストを実行する。
- **推論 API/バッチ出力**: 将来的な利用を想定し、学習済みモデルで CSV/JSON を入力して予測を返すスクリプトや FastAPI エンドポイントのドラフトを作成する。

## 実行優先度の例
1. データ取得関数とキャッシュ層の整備（再現性の基盤）。
2. 前処理 Pipeline と学習スクリプトの分離（Notebook 依存からの脱却）。
3. 検証戦略と評価レポートの高度化（性能の見える化）。
4. モデル管理・自動テスト・API 整備（継続運用の土台）。
