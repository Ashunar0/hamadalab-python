# ノートブック分析サマリー: `asao_step0_1310-with_features_total_22.ipynb`

このドキュメントは、投球分類モデルの構築と評価を行ったJupyter Notebookの詳細な分析要約です。

## 1. 分析の目的
*   **メインタスク**: トラックマンデータを用いた投球タイプ（`pitch_type`）の分類モデル構築。
*   **主な焦点**:
    *   ベースラインモデルの構築と評価。
    *   物理的特性に基づく**特徴量エンジニアリング**の効果検証。
    *   **アンサンブル学習**による精度向上。
    *   **「Worst Cases（最悪の誤分類）」**の詳細分析を通じたモデルの弱点特定。

## 2. データ処理と特徴量エンジニアリング

### 2.1 データ前処理
*   **ターゲット変数**: `pitch_type`
*   **クラス統合**: 出現頻度の低いクラス（`PO`, `EP`, `FA`など）を`Others`クラスに統合し、クラス不均衡を緩和。
*   **欠損値処理**: 欠損を含む行を削除（または補完戦略を確認）。
*   **エンコーディング**: `pitch_type`をLabel Encodingで数値化。

### 2.2 特徴量エンジニアリング
モデルに入力された特徴量は、物理的な意味合いを持つ高度な指標を含みます。

1.  **基本指標**: `release_speed`, `release_spin_rate`, `spin_axis`, `pfx_x`, `pfx_z`, `release_pos_x`, `release_pos_z`
2.  **回転・変化関連**:
    *   `movement_magnitude`: 変化量の絶対値 ($\sqrt{pfx\_x^2 + pfx\_z^2}$)。
    *   `spin_efficiency` (推定): 回転効率の代替指標。
    *   `normalized_spin_axis`: 正規化された回転軸（補足: `spin_axis_sin/cos`は作成されたが不採用）。
3.  **速度・変化の比率**:
    *   `speed_spin_ratio`: 球速と回転数の比率。
    *   `spin_per_mph`: 1マイルあたりの回転数。
    *   `velocity_pfx_product`: 球速 $\times$ 変化量などの相互作用項。
    *   **`velocity_times_pfx_z`**: **重要特徴量**。球速と縦変化の積。
    *   `velocity_abs_pfx_x_ratio`: 球速と横変化（絶対値）の比率。

## 3. モデル構築とベンチマーク結果

3つのツリー系モデルと、それらのアンサンブルモデルが評価されました。

| モデル | Validation Accuracy | 特徴 |
| :--- | :--- | :--- |
| **XGBoost (XGB)** | **0.923** | 単体で最高精度。`velocity_times_pfx_z`を極めて重視する傾向。 |
| **Ensemble (Avg)** | 0.913 | 3モデルの加重平均。安定性は高いが、今回はXGB単体に及ばず。 |
| **Random Forest (RFC)** | 0.907 | 安定したベースライン。特徴量重要度が分散しており、特定の特徴に依存しすぎない。 |
| **LightGBM (LGBM)** | 0.877 | 学習は高速だが、精度面では他の2つに劣る結果。 |

## 4. 定量的 特徴量重要度分析 (Top Features)

モデルごとに重視する特徴量が大きく異なることが判明しました。以下は正規化された重要度スコア（上位抜粋）です。

| 特徴量名 (`feature`) | Avg Importance | RF (RFC) | XGB | LGBM | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **`release_speed`** | **0.710** | **1.000** | 0.130 | **1.000** | RFとLGBMで圧倒的最重要。球速は基本にして最強の指標。 |
| **`velocity_times_pfx_z`**| **0.673** | 0.776 | **1.000** | 0.244 | **XGBで1位**。球速と縦変化の組み合わせが分類に決定的。 |
| `pfx_x` (横変化) | 0.432 | 0.434 | 0.489 | 0.374 | 全モデルで中程度の重要度。 |
| `release_spin_rate` | 0.425 | 0.366 | 0.151 | 0.758 | LGBMで特に重視される。 |
| `spin_axis` | 0.372 | 0.474 | 0.133 | 0.510 | 回転軸も重要だが、モデルによるばらつきあり。 |

*   **分析**: XGBoostは特定の特徴量（`velocity_times_pfx_z`）に「一点突破」するような学習をしており、これが高い精度につながっている可能性があります。一方、Random Forestは多くの特徴量をバランスよく使用しています。

## 5. エラー分析 (Worst Cases & SHAP)

モデルが**「高い確信度（高確率）を持って間違えた事例（Worst Cases）」**に焦点を当てた詳細分析が行われました。

### 5.1 過信の傾向 (Overconfidence)
誤分類されたサンプルにおける予測確率の統計：
*   **平均予測確率**: **0.879** (非常に高い)
*   **最大予測確率**: 1.000 (完全に確信して間違えている)
*   **90%以上の確率で誤答**: 31件
*   **80%以上の確率で誤答**: 39件
*   **結論**: モデルは「迷って間違えた」のではなく、「自信満々で間違えた」ケースが多い。これは特徴量空間上で、異種クラスが重なり合っている（不可分な）領域があることを示唆します。

### 5.2 主な誤分類パターン (Confusion Patterns)
「正解ラベル $\rightarrow$ 予測ラベル」の組み合わせで多かったもの：

1.  **SL (スライダー) $\rightarrow$ FC (カットボール)**:
    *   最も頻出するエラーの一つ。変化の性質が近く、境界線が曖昧なため典型的なミス。
2.  **CH (チェンジアップ) $\rightarrow$ FF (4シーム)**:
    *   数件発生。おそらく球速差が少ない、あるいは変化量が4シームに近い「落ちないチェンジアップ」が誤認されている可能性。
3.  **SL (スライダー) $\rightarrow$ ST (スイーパー) / Others**:
    *   スライダー系の亜種間の混同。

### 5.3 要因分析 (SHAP)
Worst Casesに対するSHAP値分析により、以下の傾向が見られました：
*   `release_speed` と `pfx_z` が誤分類の主要因となることが多い。
*   特定のサンプルでは、通常なら正解に寄与するはずの特徴量が、逆に作用している（例：スライダーにしては球速が速すぎるためカットボールと判定される、など）。

## 6. 結論と次へのステップ

1.  **XGBoostの採用**: 現状最も精度が高く、`velocity_times_pfx_z`という複合特徴量を有効活用できているため、これをメインモデルとすべきです。
2.  **特徴量の見直し**: `release_speed`への依存度が高いモデル（RF/LGBM）は、球速帯が重なる球種の判別に苦労しています。軌道や変化の「形状」を示す特徴量（曲がり始めの位置など）の追加が有効かもしれません。
3.  **Worst Cases対策**:
    *   **閾値調整**: 確信度が高い誤答が多いため、単純な確率閾値（0.5など）ではなく、クラスごとの最適閾値を設定する（Threshold Moving）。
    *   **類似クラスの統合検討**: SLとFC、SIとFFなど、物理的に連続している球種は、モデルにとって分離困難な場合があります。これらを階層的に分類する（まず「速球系」「変化球系」に分けるなど）アプローチも検討価値があります。
